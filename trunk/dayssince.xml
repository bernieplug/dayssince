<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs 
	title="Days Since"
	title_url="http://leancode.com/dayssince/"
	directory_title="Days Since ... Timer"
	description="When was the last time you watered your plants?  Serviced the car?  Gave those grubby kids a bath? Or perhaps had a drink? This widget will put your mind at rest by keeping track of these for you."
	render_inline="optional"
	author="Bernie T."
	author_email="bernie+dayssince@leancode.com"
	author_affiliation="Leancode Inc."
	author_location="Bellevue, WA"
	screenshot="http://dayssince.googlecode.com/svn/trunk/screenshot.png"
	thumbnail="http://dayssince.googlecode.com/svn/trunk/thumbnail.png"
	author_photo="http://dayssince.googlecode.com/svn/trunk/author_photo.png"
	author_aboutme="Software developer and entrepreneur. Look me up to talk about your next project."
	author_quote="Time. time. time.  Look what's become of me."
	author_link="http://leancode.com/"
	height="150"
	scrolling = "true"
>
	<Locale messages="http://dayssince.googlecode.com/svn/trunk/ALL_ALL.xml"/>
	<Require feature="analytics"/>
	<Require feature="dynamic-height"/>
	<Require feature="setprefs"/>
	<Require feature="minimessage"/>
</ModulePrefs>
<UserPref name="reminders" datatype="string" default_value=""></UserPref>
<Content type="html">
<![CDATA[

<script language="JavaScript" src="http://dayssince.googlecode.com/svn/trunk/json.js"></script>

<script>
	
	var reminders__MODULE_ID__; // This is a json object of reminders (array of hashes with 'description' & 'lastreset')
	var prefs__MODULE_ID__;
	var minutes = 1000*60;
	var hours = minutes*60;
	var days = hours*24;
	var years = days*365;
		
	function loadReminders__MODULE_ID__() {
		prefs__MODULE_ID__ = new _IG_Prefs(__MODULE_ID__);
		var reminders = prefs__MODULE_ID__.getString("reminders");
				
		if (reminders == "") {
			reminders__MODULE_ID__ = {"array":[]};
		} else {
			reminders__MODULE_ID__.array = reminders.parseJSON(function (key, value) {
			        return key == 'lastreset' ? new Date(parseInt(value)) : value;
			    });
		}
		
		if (!(reminders__MODULE_ID__.array.length >= 1))
			reminders__MODULE_ID__ = {"array":[]};
			
		createTable__MODULE_ID__();
	}
	
	_IG_RegisterOnloadHandler(loadReminders__MODULE_ID__);

	function saveReminders__MODULE_ID__(){
		prefs__MODULE_ID__.set("reminders", reminders__MODULE_ID__.array.toJSONString());
	}

	function addReminder__MODULE_ID__(description, daysago_string) {
		var description = _trim(description);
		var date = new Date();
		var daysago = parseInt(daysago_string);
		
		date.setDate(date.getDate()-daysago);
		
		_gel("newReminderInput__MODULE_ID__").value = "";
		if (description == "")
			return;
			
		reminders__MODULE_ID__.array[reminders__MODULE_ID__.array.length] =
			{"description": description, "lastreset": date };
			
		saveReminders__MODULE_ID__();
		loadReminders__MODULE_ID__();
		return false;
	}

	function deleteReminder__MODULE_ID__(number) {
		var beginning = reminders__MODULE_ID__.array.slice(0, number);
		var end = reminders__MODULE_ID__.array.slice(number + 1,
		                                      reminders__MODULE_ID__.array.length);
		
		reminders__MODULE_ID__.array = beginning.concat(end);
		saveReminders__MODULE_ID__();
		loadReminders__MODULE_ID__();
	}
	
	function resetReminder__MODULE_ID__(number) {
		var now = new Date();
		var row = getRow__MODULE_ID__(number);
		var col = getCol__MODULE_ID__(row, 0);
		
		col.innerHTML = "0";
		reminders__MODULE_ID__.array[number].lastreset = now;
		saveReminders__MODULE_ID__();
		loadReminders__MODULE_ID__();
	}

	function rowClass__MODULE_ID__(number) {
		if (number % 2 != 0)
			return " class=odd__MODULE_ID__ ";
		else
			return " class=even__MODULE_ID__ ";
	}

	function createTable__MODULE_ID__() {
		var html = "<table cellspacing=0 id=remindersTable__MODULE_ID__>";
		
		for (i = 0; i < reminders__MODULE_ID__.array.length; i++) {
			if (reminders__MODULE_ID__.array[i] == null)
				break;
			
			var description = reminders__MODULE_ID__.array[i].description;
			var lastreset = reminders__MODULE_ID__.array[i].lastreset;
		
			html = html + createRow__MODULE_ID__(i, description, lastreset);
		}
		
		html = html + "</table>";
		_gel("remindersDiv__MODULE_ID__").innerHTML = html;
		_IG_AdjustIFrameHeight();
		_gel("newReminderInput__MODULE_ID__").focus();
	}

	function createRow__MODULE_ID__(number, description, lastreset) {
		var now = new Date();
		var dayssince = (now.getTime() - lastreset.getTime())/days;
		
		var html =
			"<tr id=\"row" + number + "__MODULE_ID__\"" +
			rowClass__MODULE_ID__(number) + ">" +
			"<td class=dayssince_ds__MODULE_ID__><span class=dayssince_ds__MODULE_ID__>" + 
			Math.floor(dayssince) +
			"</span></td>" +
			"<td class=description_td__MODULE_ID__>" +
			_hesc(description) +
			"</td>" +
			"<td>" +
			createReset__MODULE_ID__(number) +
			"</td>" +
			"<td>" +
			createDelete__MODULE_ID__(number) +
			"</td>" +
			"</tr>";

		return html;
	}

	function createDelete__MODULE_ID__(number) {
		var html =
			"<a href=\"javascript:deleteReminder__MODULE_ID__(" + number + ")\">" +
			"<img class=delete__MODULE_ID__" +
			" src=\"http://dayssince.googlecode.com/svn/trunk/x.gif\">" +
			"</a>";
		return html;
	}

	function createReset__MODULE_ID__(number) {
		var html =
			"<a href=\"javascript:resetReminder__MODULE_ID__(" + number + ")\">" +
			"<img class=reset__MODULE_ID__" +
			" src=\"http://dayssince.googlecode.com/svn/trunk/reset.gif\">" +
			"</a>";
		return html;
	}

	function getRow__MODULE_ID__(number) {
		return _gel("row" + number + "__MODULE_ID__");
	}

	function getCol__MODULE_ID__(row, index) {
		return row.childNodes.item(index);
	}
	
	function submitOnEnter__MODULE_ID__(e, form) {
		var characterCode;
		if(e && e.which){
			e = e
			characterCode = e.which
		} else {
			e = event
			characterCode = e.keyCode
		}
		
		if (characterCode == 13) {
			form.submit()
		}
		
		return e
	}

	_IG_Analytics("UA-99119-12", "/dayssince");
	
</script>

<style type="text/css">
	
	td.description_td__MODULE_ID__ {
		width: 100%;
		margin: 0 0 0 30px;
		text-align: center;
	}
	
	span.dayssince_ds__MODULE_ID__ {
		border: thick solid #00008B;
		padding: 10px;
		background-color: #00BFFF;
		color: #00008B;
		font-size: x-large;
		margin: 0 20px 0 0;
	}
	
	img.delete__MODULE_ID__ {
		border: 0;
		margin: 0;
	}
	
	img.reset__MODULE_ID__ {
		border: 0;
		margin: 0;	
		width: 48px;
	}
	
</style>

<form name = "newReminderForm__MODULE_ID__"
	onsubmit="return addReminder__MODULE_ID__(
	document.newReminderForm__MODULE_ID__.
	newReminderInput__MODULE_ID__.value,
	document.newReminderForm__MODULE_ID__.
	newDaysSinceInput__MODULE_ID__.value)">
	<table cellspacing=0>
		<tr>
			<td nowrap>
				<input size="4" id="newDaysSinceInput__MODULE_ID__" 
					value="0" type="text"> __MSG_dayssince__
			</td>
			<td style='width:100%' >
				<input id="newReminderInput__MODULE_ID__" type="text"
						style='width:100%'
 />
			</td>
			<td>
				<input type='button' value="__MSG_Add__"
							onclick = "javascript:addReminder__MODULE_ID__(
							document.newReminderForm__MODULE_ID__.
							newReminderInput__MODULE_ID__.value,
							document.newReminderForm__MODULE_ID__.
							newDaysSinceInput__MODULE_ID__.value)" />
			</td>
		</tr>
	</table>
	<div id="remindersDiv__MODULE_ID__"></div>
</form>

]]>
</Content>
</Module>

